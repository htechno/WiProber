name: Build APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug Universal APK
        run: ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: wiprober-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Display APK info
        run: |
          echo "‚úÖ APK successfully built!"
          ls -lh app/build/outputs/apk/debug/
          echo "APK size: $(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)"

      - name: Prepare APK for release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          # Copy and rename APK with version
          cp app/build/outputs/apk/debug/app-debug.apk WiProber-v${VERSION}-universal.apk
          echo "APK renamed to: WiProber-v${VERSION}-universal.apk"
          ls -lh WiProber-v${VERSION}-universal.apk

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: WiProber-v*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üì± WiProber Universal APK

            –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π APK –¥–ª—è –≤—Å–µ—Ö Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (arm64, arm32, x86, x86_64).

            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –∏–∑ Assets –Ω–∏–∂–µ
            2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (—Ç—Ä–µ–±—É–µ—Ç—Å—è Android 9.0+)
            3. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è

            ### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
            –°–º. –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π changelog –Ω–∏–∂–µ.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
